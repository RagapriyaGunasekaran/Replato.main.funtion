<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Replateo - Smart Food Management</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide (icons) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background: #fefcfb; }
    .modal-enter { transition: opacity .25s, transform .25s; opacity: 0; transform: translateY(-10px); }
    .modal-enter-active { opacity: 1; transform: translateY(0); }
    .modal-exit-active { opacity: 0; }
    /* a bit more spacing for mobile toast */
    #toast-root { z-index: 80; pointer-events: none; }
  </style>
</head>
<body class="text-gray-800">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white shadow">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-6">
          <a href="#home" class="text-2xl font-bold text-orange-600" onclick="route('#home')">
            <img src="https://i.ibb.co/d0NpdWn9/Logo.png" alt="Replateo Logo" class="h-12 w-auto logo-image">
          </a>
        </div>

        <div class="hidden md:flex items-center space-x-6">
          <a class="text-gray-600 hover:text-orange-600" href="#good-food" onclick="route('#good-food')">Edible</a>
          <a class="text-gray-600 hover:text-orange-600" href="#non-edible" onclick="route('#non-edible')">Non-Edible</a>
          <a class="text-gray-600 hover:text-orange-600" href="#directory" onclick="route('#directory')">Directory</a>
          <a class="text-gray-600 hover:text-orange-600" href="#public-listings" onclick="route('#public-listings')">Listings</a>
          <a class="text-gray-600 hover:text-orange-600" href="#contact" onclick="route('#contact')">Support</a>
        </div>

        <div class="flex items-center space-x-3">
          <button id="dashboard-link" class="hidden text-white bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg text-sm font-medium shadow" onclick="route('#dashboard')">Dashboard</button>
          <button id="auth-button" class="text-white bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg text-sm font-medium shadow" onclick="openAuthModal()">Login / Register</button>
          <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-orange-600 focus:outline-none">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
        </div>
      </div>
    </nav>

    <div id="mobile-menu" class="hidden md:hidden bg-white shadow-inner pb-4 text-sm font-medium">
      <a href="#good-food" class="block px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="route('#good-food')">Edible</a>
      <a href="#non-edible" class="block px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="route('#non-edible')">Non-Edible</a>
      <a href="#directory" class="block px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="route('#directory')">Directory</a>
      <a href="#public-listings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="route('#public-listings')">Listings</a>
      <a href="#contact" class="block px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="route('#contact')">Support</a>
    </div>
  </header>

  <!-- Main -->
  <main id="app-content">
    <!-- Home -->
    <section id="home" class="min-h-screen flex items-center section-padding bg-white p-12">
      <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-12">
        <div class="text-left">
          <span class="inline-block bg-orange-100 text-orange-700 text-xs font-semibold px-3 py-1 rounded-full uppercase tracking-wider mb-4">Fighting Food Waste Together</span>
          <h1 class="text-5xl lg:text-6xl font-extrabold leading-tight mb-6 text-gray-900">Zero Food Waste: <span class="text-orange-600">Share, Recycle, Sustain.</span></h1>
          <p class="text-lg text-gray-500 mb-8 max-w-lg">Connect surplus edible food with those who need it — donate, list at a discount, or recycle responsibly.</p>
          <div class="flex flex-col sm:flex-row gap-4">
            <button class="px-8 py-3 text-lg font-semibold text-white bg-orange-600 rounded-xl hover:bg-orange-700 shadow" onclick="route('#good-food')">I Have Food to Share</button>
            <button class="px-8 py-3 text-lg font-semibold text-gray-700 bg-white border rounded-xl hover:bg-gray-50" onclick="route('#non-edible')">I Need to Recycle</button>
          </div>
        </div>

        <div class="hidden md:block">
          <img alt="sustainable food loop" class="w-full h-auto rounded-xl shadow-2xl" src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1200&q=60" />
        </div>
      </div>
    </section>

    <!-- Good Food -->
    <section id="good-food" class="hidden section-padding bg-orange-50 py-12">
      <div class="max-w-5xl mx-auto text-center">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-6">Manage Surplus Edible Food</h2>
        <p class="text-xl text-gray-600 mb-12">Connect food safe for consumption with those who can use it—donate or list at a discount.</p>

        <div class="grid md:grid-cols-3 gap-8">
          <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-orange-500">
            <i data-lucide="hand-heart" class="w-10 h-10 text-orange-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Donation</h3>
            <p class="text-gray-600 mb-4">Give your surplus food directly to local NGOs and charities for free.</p>
            <button class="bg-orange-600 text-white py-2 px-6 rounded-lg hover:bg-orange-700" onclick="openDonationModal('edible')">Start Donation</button>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-orange-500">
            <i data-lucide="tag" class="w-10 h-10 text-orange-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Discounted Sale</h3>
            <p class="text-gray-600 mb-4">List items for individuals or businesses to purchase at a reduced rate.</p>
            <button class="bg-orange-600 text-white py-2 px-6 rounded-lg hover:bg-orange-700" onclick="openSaleModal('edible')">List for Sale</button>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-orange-500">
            <i data-lucide="upload-cloud" class="w-10 h-10 text-orange-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-3">View Listings</h3>
            <p class="text-gray-600 mb-4">Browse all public donation & sale listings.</p>
            <button class="bg-gray-300 text-gray-700 py-2 px-6 rounded-lg" onclick="route('#public-listings')">View Listings</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Non-Edible (green-themed) -->
    <section id="non-edible" class="hidden section-padding bg-emerald-50 py-12">
      <div class="max-w-5xl mx-auto text-center">
        <h2 class="text-4xl font-extrabold text-emerald-900 mb-6">Non-Edible Food Waste — Recycle & Repurpose</h2>
        <p class="text-xl text-emerald-700 mb-12">For food that cannot be consumed, we provide avenues for composting, fertilizer production, and agricultural reuse.</p>

        <div class="grid md:grid-cols-2 gap-8 max-w-3xl mx-auto">
          <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-emerald-600">
            <i data-lucide="recycle" class="w-10 h-10 text-emerald-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Recycling & Composting</h3>
            <p class="text-emerald-700 mb-4">Find partners that convert non-edible waste into compost or bioenergy.</p>
            <button class="bg-emerald-600 text-white py-2 px-6 rounded-lg hover:bg-emerald-700" onclick="route('#directory')">Find Recyclers</button>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-emerald-600">
            <i data-lucide="seedling" class="w-10 h-10 text-emerald-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Send to Agriculture</h3>
            <p class="text-emerald-700 mb-4">Donate non-edible matter to agricultural partners for fertilizer or soil enhancers.</p>
            <button class="bg-emerald-600 text-white py-2 px-6 rounded-lg hover:bg-emerald-700" onclick="openDonationModal('non-edible')">Donate Non-Edible</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Public Listings -->
    <section id="public-listings" class="hidden section-padding bg-white py-12">
      <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-3xl font-extrabold text-gray-900">Public Listings</h2>
            <p class="text-gray-600">Real-time donation & sale listings from the community.</p>
          </div>
          <div class="flex items-center gap-3">
            <select id="filter-type" class="p-2 border rounded-md" onchange="renderPublicListingsFilter()">
              <option value="all">All types</option>
              <option value="donation">Donation</option>
              <option value="sale">Sale</option>
            </select>
            <select id="filter-category" class="p-2 border rounded-md" onchange="renderPublicListingsFilter()">
              <option value="all">All categories</option>
              <option value="edible">Edible</option>
              <option value="non-edible">Non-Edible</option>
            </select>
            <button class="py-2 px-4 bg-orange-600 text-white rounded-md" onclick="fetchPublicListings()">Refresh</button>
          </div>
        </div>

        <div id="listings-grid" class="grid md:grid-cols-3 gap-6"></div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="hidden min-h-screen section-padding bg-white py-12">
      <div class="max-w-5xl mx-auto">
        <div id="dashboard-content" class="p-8 bg-orange-50 rounded-2xl shadow-xl text-center hidden">
          <h2 class="text-4xl font-extrabold text-gray-900 mb-4">Welcome Back, <span id="user-name">User</span>!</h2>
          <p class="text-xl text-orange-700 mb-8">Your Replateo Management Hub.</p>

          <div id="dashboard-status" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
            <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-green-500">
              <p class="text-sm text-gray-500">Donations Posted</p>
              <p id="dashboard-donations" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-blue-500">
              <p class="text-sm text-gray-500">Sale Listings</p>
              <p id="dashboard-sales" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-orange-500">
              <p class="text-sm text-gray-500">Pending Actions</p>
              <p id="dashboard-pending" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
          </div>

          <div id="dashboard-listings" class="mt-8 text-left">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Your Listings</h3>
            <div id="user-listings" class="space-y-4"></div>
          </div>

          <p class="mt-8 text-gray-600">
            <a href="#" class="text-orange-600 hover:underline font-medium" onclick="signOutUser()">Click here to safely Sign Out.</a>
          </p>
        </div>

        <div id="dashboard-unauthenticated" class="p-12 bg-white rounded-2xl shadow-xl text-center">
          <i data-lucide="lock" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
          <h3 class="text-2xl font-bold text-gray-900 mb-3">Access Denied</h3>
          <p class="text-gray-600 mb-6">Please log in or register to view your personal dashboard.</p>
          <button class="bg-orange-600 text-white py-2 px-6 rounded-xl hover:bg-orange-700 transition" onclick="openAuthModal()">Login / Register</button>
        </div>
      </div>
    </section>

    <!-- Directory -->
    <section id="directory" class="hidden section-padding bg-orange-50 py-12">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">Find Partners Near You</h2>
        <p class="text-xl text-gray-600 mb-12 text-center">Browse our curated list of authenticated NGOs, food banks, and recyclers.</p>

        <div id="directory-list" class="space-y-6">
          <!-- sample directory items -->
          <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center gap-6">
            <img src="https://images.unsplash.com/photo-1526779259212-94c1d0b5a8d2?auto=format&fit=crop&w=400&q=60" alt="NGO" class="w-24 h-24 rounded-lg object-cover">
            <div class="flex-1 text-left">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg">Community Food Bank</h3>
                  <p class="text-gray-600">Charity - accepts edible donations and distributes to local shelters.</p>
                </div>
                <div class="text-sm text-gray-500">Verified</div>
              </div>
              <div class="mt-3">
                <button class="py-2 px-4 bg-emerald-600 text-white rounded-md" onclick="toast('Contacting partner...')">Contact</button>
              </div>
            </div>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center gap-6">
            <img src="https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=400&q=60" alt="Recycler" class="w-24 h-24 rounded-lg object-cover">
            <div class="flex-1 text-left">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg">GreenCycle Composters</h3>
                  <p class="text-gray-600">Industrial composting and fertilizer production — accepts non-edible food waste.</p>
                </div>
                <div class="text-sm text-gray-500">Partner</div>
              </div>
              <div class="mt-3">
                <button class="py-2 px-4 bg-emerald-600 text-white rounded-md" onclick="toast('Partner info sent to your email (placeholder)')">Request Pickup</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact" class="hidden section-padding bg-gray-900 text-white py-12">
      <div class="max-w-6xl mx-auto">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-extrabold text-white mb-4">Need Support? Get In Touch</h2>
          <p class="text-xl text-gray-400">Our team is ready to help with platform issues, partnerships, or general inquiries.</p>
        </div>

        <div class="max-w-lg mx-auto bg-gray-800 p-8 rounded-2xl shadow-2xl">
          <form id="contact-form" class="space-y-6" onsubmit="handleFormSubmission(event)">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
              <input type="text" id="contact-name" required class="w-full p-3 rounded-lg border-gray-600 bg-gray-700 text-white">
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
              <input type="email" id="contact-email" required class="w-full p-3 rounded-lg border-gray-600 bg-gray-700 text-white">
            </div>
            <div>
              <label for="message" class="block text-sm font-medium text-gray-300 mb-1">Your Inquiry</label>
              <textarea id="contact-message" required rows="4" class="w-full p-3 rounded-lg border-gray-600 bg-gray-700 text-white"></textarea>
            </div>
            <button id="contact-submit" class="w-full py-3 text-lg font-semibold text-white bg-orange-600 rounded-xl">Send Message</button>
          </form>
          <div id="form-message" class="mt-4 text-center hidden"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="auth-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div id="modal-content" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
      <div class="flex justify-between items-center mb-6">
        <h2 id="auth-title" class="text-2xl font-bold text-gray-900">Login to Replateo</h2>
        <button class="text-gray-400 hover:text-gray-600" onclick="closeAuthModal()">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="auth-form" class="space-y-4" onsubmit="handleAuthSubmit(event)">
        <input type="hidden" id="auth-mode" value="login">
        <div>
          <label for="auth-email" class="block text-sm font-medium text-gray-700">Email Address</label>
          <input type="email" id="auth-email" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg" placeholder="you@example.com">
        </div>
        <div>
          <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="auth-password" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg" placeholder="••••••••">
        </div>
        <div id="auth-name-group" class="hidden">
          <label for="auth-name" class="block text-sm font-medium text-gray-700">Full Name</label>
          <input type="text" id="auth-name" class="w-full mt-1 p-3 border border-gray-300 rounded-lg" placeholder="John Doe">
        </div>
        <div id="auth-message" class="text-sm text-red-500"></div>

        <button type="submit" id="auth-submit-btn" class="w-full py-3 text-lg font-semibold text-white bg-orange-600 rounded-xl">Login</button>
      </form>

      <p class="mt-4 text-center text-sm">
        <span id="toggle-auth-text">Don't have an account?</span>
        <button type="button" class="text-orange-600 hover:text-orange-700 font-medium" onclick="toggleAuthMode()">Register</button>
      </p>
    </div>
  </div>

  <!-- Donation Modal -->
  <div id="donation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-xl">
      <h3 class="text-xl font-bold mb-4">Donate Food</h3>
      <form id="donation-form" onsubmit="handleDonationSubmit(event)" class="space-y-3">
        <input type="text" id="donation-title" placeholder="Food item (e.g., 20 prepared meals)" required class="w-full p-3 border rounded-lg">
        <input type="number" id="donation-quantity" placeholder="Quantity" required class="w-full p-3 border rounded-lg">
        <input type="text" id="donation-address" placeholder="Pickup Address" required class="w-full p-3 border rounded-lg">
        <select id="donation-category" class="w-full p-3 border rounded-lg">
          <option value="edible">Edible</option>
          <option value="non-edible">Non-Edible</option>
        </select>
        <input type="url" id="donation-image" placeholder="Image URL (optional)" class="w-full p-3 border rounded-lg">
        <textarea id="donation-notes" placeholder="Notes (optional)" class="w-full p-3 border rounded-lg"></textarea>
        <div class="flex gap-3">
          <button type="submit" class="w-full py-3 bg-orange-600 text-white rounded-lg">Submit Donation</button>
          <button type="button" class="w-32 py-3 bg-gray-200 rounded-lg" onclick="closeDonationModal()">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sale Modal -->
  <div id="sale-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-xl">
      <h3 class="text-xl font-bold mb-4">List Item for Sale (Discounted)</h3>
      <form id="sale-form" onsubmit="handleSaleSubmit(event)" class="space-y-3">
        <input type="text" id="sale-item" placeholder="Item name (e.g., 10x lunch packs)" required class="w-full p-3 border rounded-lg">
        <input type="number" id="sale-price" placeholder="Price (INR)" required class="w-full p-3 border rounded-lg">
        <input type="text" id="sale-address" placeholder="Pickup Address" required class="w-full p-3 border rounded-lg">
        <select id="sale-category" class="w-full p-3 border rounded-lg">
          <option value="edible">Edible</option>
          <option value="non-edible">Non-Edible</option>
        </select>
        <input type="url" id="sale-image" placeholder="Image URL (optional)" class="w-full p-3 border rounded-lg">
        <textarea id="sale-notes" placeholder="Notes (optional)" class="w-full p-3 border rounded-lg"></textarea>
        <div class="flex gap-3">
          <button type="submit" class="w-full py-3 bg-orange-600 text-white rounded-lg">Post Listing</button>
          <button type="button" class="w-32 py-3 bg-gray-200 rounded-lg" onclick="closeSaleModal()">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-root" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-60"></div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <p class="text-lg font-semibold text-orange-400 mb-2">Replateo</p>
      <p class="text-sm text-gray-400">&copy; 2025 Replateo Innovations. All rights reserved.</p>
    </div>
  </footer>

  <!-- Main App Script -->
  <script type="module">
  // ================= FIREBASE IMPORTS =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    onSnapshot,
    orderBy,
    serverTimestamp,
    doc,
    setDoc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ================= FIREBASE CONFIG (from your uploaded file) =================
  const firebaseConfig = {
    apiKey: "AIzaSyCRopzTmLLunMb6QJV_9EnTd2qiqaOBol4",
    authDomain: "repletaodatastore.firebaseapp.com",
    projectId: "repletaodatastore",
    storageBucket: "repletaodatastore.firebasestorage.app",
    messagingSenderId: "88604146047",
    appId: "1:88604146047:web:a4b9f0f3f5784935f0824a",
    measurementId: "G-FQF609DDGF"
  };

  // ================= FIREBASE INIT =================
  let app, auth, db;
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    console.log("✅ Firebase initialized successfully!");
  } catch (err) {
    console.error("❌ Firebase init error:", err);
  }

  // ================= GLOBAL WINDOW FUNCTIONS =================
  window.openAuthModal = function() {
    document.getElementById('auth-modal').classList.remove('hidden');
  };
  window.closeAuthModal = function() {
    document.getElementById('auth-modal').classList.add('hidden');
    document.getElementById('auth-message').textContent = '';
  };

  window.toggleAuthMode = function() {
    const mode = document.getElementById('auth-mode');
    const title = document.getElementById('auth-title');
    const btn = document.getElementById('auth-submit-btn');
    const nameGroup = document.getElementById('auth-name-group');
    const toggleText = document.getElementById('toggle-auth-text');

    if (mode.value === 'login') {
      mode.value = 'register';
      title.textContent = 'Register New Account';
      btn.textContent = 'Register';
      nameGroup.classList.remove('hidden');
      toggleText.textContent = 'Already have an account?';
    } else {
      mode.value = 'login';
      title.textContent = 'Login to Replateo';
      btn.textContent = 'Login';
      nameGroup.classList.add('hidden');
      toggleText.textContent = "Don't have an account?";
    }
  };

  // Donation & Sale Modal helpers
  window.openDonationModal = function(defaultCategory = 'edible') {
    document.getElementById('donation-modal').classList.remove('hidden');
    document.getElementById('donation-category').value = defaultCategory;
  };
  window.closeDonationModal = function() {
    document.getElementById('donation-modal').classList.add('hidden');
    document.getElementById('donation-form').reset();
  };
  window.openSaleModal = function(defaultCategory = 'edible') {
    document.getElementById('sale-modal').classList.remove('hidden');
    document.getElementById('sale-category').value = defaultCategory;
  };
  window.closeSaleModal = function() {
    document.getElementById('sale-modal').classList.add('hidden');
    document.getElementById('sale-form').reset();
  };

  // Toast
  window.toast = function(message, type = "success") {
    const root = document.getElementById('toast-root');
    const id = `toast-${Date.now()}`;
    const div = document.createElement('div');
    div.id = id;
    div.className = "px-6 py-3 rounded-xl shadow-2xl mb-2 inline-block opacity-100 transition-all pointer-events-auto";
    if (type === 'error') {
      div.classList.add('bg-red-600','text-white');
    } else {
      div.classList.add('bg-green-600','text-white');
    }
    div.textContent = message;
    root.appendChild(div);
    setTimeout(() => {
      div.style.opacity = '0';
      setTimeout(() => div.remove(), 300);
    }, 3000);
  };

  // ================= AUTHENTICATION HANDLERS =================
  window.handleAuthSubmit = async function(e) {
    e.preventDefault();
    if (!auth) { document.getElementById('auth-message').textContent = 'Firebase not configured.'; return; }

    const mode = document.getElementById('auth-mode').value;
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const name = document.getElementById('auth-name').value.trim();
    const msgEl = document.getElementById('auth-message');
    msgEl.style.color = 'black';
    msgEl.textContent = 'Processing...';

    try {
      if (mode === 'register') {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        if (name) await updateProfile(cred.user, { displayName: name });
        await setUserProfileDoc(cred.user.uid, { name, email });
        msgEl.style.color = 'green';
        msgEl.textContent = 'Registration successful!';
        toast('Account created successfully!');
      } else {
        await signInWithEmailAndPassword(auth, email, password);
        msgEl.style.color = 'green';
        msgEl.textContent = 'Login successful!';
        toast('Welcome back!');
      }
      setTimeout(() => { closeAuthModal(); window.location.hash = '#dashboard'; }, 800);
    } catch (err) {
      console.error("Auth error:", err);
      msgEl.style.color = 'red';
      const msg = (err?.message || '').replace('Firebase: ', '') || 'Authentication failed';
      msgEl.textContent = msg;
    }
  };

  async function setUserProfileDoc(uid, data = {}) {
    if (!db) return;
    try {
      const pRef = doc(db, `users`, uid);
      await setDoc(pRef, { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true });
      console.log('User profile created in Firestore');
    } catch (err) { console.error("setUserProfileDoc error:", err); }
  }

  // ================= LISTING HANDLERS =================
  window.handleDonationSubmit = async function(e) {
    e.preventDefault();
    if (!auth?.currentUser) { toast('Please login first', 'error'); openAuthModal(); return; }

    const currentUserId = auth.currentUser.uid;
    const title = document.getElementById('donation-title').value.trim();
    const quantity = document.getElementById('donation-quantity').value;
    const address = document.getElementById('donation-address').value.trim();
    const notes = document.getElementById('donation-notes').value.trim();
    const category = document.getElementById('donation-category').value || 'edible';
    const image = document.getElementById('donation-image').value.trim() || null;

    if (!title || !quantity || !address) { toast('Please fill all required fields', 'error'); return; }

    try {
      const docRef = await addDoc(collection(db, 'food_listings'), {
        userId: currentUserId,
        type: 'donation',
        title,
        quantity: Number(quantity),
        address,
        notes,
        category,
        image: image || null,
        status: 'available',
        createdAt: serverTimestamp()
      });
      toast('Donation posted successfully!');
      closeDonationModal();
    } catch (err) {
      console.error('Firestore error:', err);
      toast('Error posting donation: ' + (err.message || err), 'error');
    }
  };

  window.handleSaleSubmit = async function(e) {
    e.preventDefault();
    if (!auth?.currentUser) { toast('Please login first', 'error'); openAuthModal(); return; }

    const currentUserId = auth.currentUser.uid;
    const title = document.getElementById('sale-item').value.trim();
    const price = document.getElementById('sale-price').value;
    const address = document.getElementById('sale-address').value.trim();
    const notes = document.getElementById('sale-notes').value.trim();
    const category = document.getElementById('sale-category').value || 'edible';
    const image = document.getElementById('sale-image').value.trim() || null;

    if (!title || !price || !address) { toast('Please fill all required fields', 'error'); return; }

    try {
      const docRef = await addDoc(collection(db, 'food_listings'), {
        userId: currentUserId,
        type: 'sale',
        title,
        price: Number(price),
        address,
        notes,
        category,
        image: image || null,
        status: 'available',
        createdAt: serverTimestamp()
      });
      toast('Sale listing posted successfully!');
      closeSaleModal();
    } catch (err) {
      console.error('Firestore error:', err);
      toast('Error posting sale: ' + (err.message || err), 'error');
    }
  };

  // Mark item claimed (buyer/ngos mark as claimed) and send to agriculture
  window.markAsClaimed = async function(listingId) {
    try {
      const ref = doc(db, 'food_listings', listingId);
      await updateDoc(ref, { status: 'claimed', claimedAt: serverTimestamp() });
      toast('Listing marked as claimed');
    } catch (err) {
      console.error(err);
      toast('Error updating listing', 'error');
    }
  };

  window.sendToAgriculture = async function(listingId) {
    try {
      // create agri request
      await addDoc(collection(db, 'agri_requests'), {
        listingId,
        createdAt: serverTimestamp(),
        status: 'requested'
      });
      // optionally mark listing status
      const ref = doc(db, 'food_listings', listingId);
      await updateDoc(ref, { status: 'agri_requested' });
      toast('Sent to agriculture partners');
    } catch (err) {
      console.error(err);
      toast('Error sending to agriculture', 'error');
    }
  };

  // ================= ROUTING & RENDERING =================
  const mainSections = ['home','good-food','non-edible','dashboard','directory','contact','public-listings'];

  window.route = function(hash) {
    const id = hash.startsWith('#') ? hash.substring(1) : hash;
    if (mainSections.includes(id)) {
      window.location.hash = id;
      showPage(id);
    }
  };

  function showPage(pageId) {
    mainSections.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    });

    const target = document.getElementById(pageId);
    if (target) {
      if (pageId === 'dashboard' && !auth?.currentUser) {
        document.getElementById('dashboard-unauthenticated').classList.remove('hidden');
        document.getElementById('dashboard-content').classList.add('hidden');
      } else {
        target.classList.remove('hidden');
      }
    } else {
      document.getElementById('home').classList.remove('hidden');
    }

    if (window.lucide) lucide.createIcons();

    // special actions when opening listings/dashboard
    if (pageId === 'public-listings') fetchPublicListings();
    if (pageId === 'dashboard') fetchUserListings();
  }

  function checkRoute() {
    let hash = window.location.hash.replace('#','');
    if (!hash || !mainSections.includes(hash)) hash = 'home';
    showPage(hash);
  }
  window.onhashchange = checkRoute;

  // ================= AUTH STATE MANAGEMENT =================
  let currentUserId = null;
  let userListingsUnsub = null;
  let publicListingsUnsub = null;

  onAuthStateChanged(auth, user => {
    console.log('Auth state:', user ? 'Logged in' : 'Logged out');
    updateUI(!!user, user);
    currentUserId = user?.uid ?? null;
    checkRoute();
  });

  function updateUI(loggedIn, user = null) {
    const authButton = document.getElementById('auth-button');
    const dashLink = document.getElementById('dashboard-link');

    if (loggedIn) {
      authButton.textContent = 'Sign Out';
      authButton.onclick = signOutUser;
      dashLink.classList.remove('hidden');
      document.getElementById('dashboard-content').classList.remove('hidden');
      document.getElementById('dashboard-unauthenticated').classList.add('hidden');
      document.getElementById('user-name').textContent = (user?.displayName || (user?.email || 'User')).split(' ')[0];
      fetchUserListings();
    } else {
      authButton.textContent = 'Login / Register';
      authButton.onclick = openAuthModal;
      dashLink.classList.add('hidden');
      document.getElementById('dashboard-content').classList.add('hidden');
      document.getElementById('dashboard-unauthenticated').classList.remove('hidden');
      document.getElementById('user-name').textContent = 'User';
      clearUserListingsUI();
    }

    if (window.lucide) lucide.createIcons();
  }

  function clearUserListingsUI() {
    const listingsEl = document.getElementById('user-listings');
    if (listingsEl) listingsEl.innerHTML = '';
    document.getElementById('dashboard-donations').textContent = '0';
    document.getElementById('dashboard-sales').textContent = '0';
    document.getElementById('dashboard-pending').textContent = '0';
  }

  // fetch user's listings and keep live counts
  async function fetchUserListings() {
    if (!db || !currentUserId) return;
    if (userListingsUnsub) userListingsUnsub();

    const q = query(collection(db, 'food_listings'), where('userId','==', currentUserId), orderBy('createdAt','desc'));
    userListingsUnsub = onSnapshot(q, snap => {
      const arr = [];
      let donations = 0, sales = 0, pending = 0;
      snap.forEach(d => {
        const data = { id: d.id, ...d.data() };
        arr.push(data);
        if (data.type === 'donation') donations++;
        if (data.type === 'sale') sales++;
        if (data.status === 'available') pending++;
      });

      document.getElementById('dashboard-donations').textContent = String(donations);
      document.getElementById('dashboard-sales').textContent = String(sales);
      document.getElementById('dashboard-pending').textContent = String(pending);

      renderUserListings(arr);
    }, err => {
      console.error('User listings error:', err);
    });
  }

  function renderUserListings(list) {
    const el = document.getElementById('user-listings');
    el.innerHTML = '';
    if (!list.length) { el.innerHTML = '<p class="text-gray-600">No listings found.</p>'; return; }
    list.forEach(item => {
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-lg shadow flex gap-4 items-start';
      card.innerHTML = `
        <div class="w-24 h-24 rounded-md overflow-hidden flex-shrink-0">
          <img src="${item.image || 'https://images.unsplash.com/photo-1528731708534-816fe59f90ca?auto=format&fit=crop&w=400&q=60'}" alt="${escapeHtml(item.title)}" class="w-full h-full object-cover">
        </div>
        <div class="flex-1 text-left">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h4 class="font-bold">${escapeHtml(item.title)}</h4>
              <div class="text-sm text-gray-600">${escapeHtml(item.type)} • ${escapeHtml(item.category || '')}</div>
            </div>
            <div class="text-sm text-gray-500">${escapeHtml(item.status || '')}</div>
          </div>
          <p class="mt-2 text-sm text-gray-700">${escapeHtml(item.notes || '')}</p>
          <div class="mt-3 flex gap-2">
            ${item.status === 'available' ? `<button class="py-1 px-3 bg-orange-600 text-white rounded-md text-sm" onclick="markAsClaimed('${item.id}')">Mark Claimed</button>` : `<span class="text-sm px-3 py-1 rounded-md bg-gray-100">Status: ${escapeHtml(item.status)}</span>`}
            ${item.category === 'non-edible' ? `<button class="py-1 px-3 bg-emerald-600 text-white rounded-md text-sm" onclick="sendToAgriculture('${item.id}')">Send to Agriculture</button>` : ''}
          </div>
        </div>
      `;
      el.appendChild(card);
    });
  }

  // ================= PUBLIC LISTINGS =================
  function fetchPublicListings() {
    if (!db) return;
    if (publicListingsUnsub) publicListingsUnsub();

    const q = query(collection(db, 'food_listings'), orderBy('createdAt','desc'));
    publicListingsUnsub = onSnapshot(q, snap => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      renderPublicListings(arr);
    }, err => {
      console.error('Public listings error:', err);
    });
  }

  function renderPublicListings(allItems) {
    // basic filter selectors
    const typeFilter = document.getElementById('filter-type')?.value || 'all';
    const categoryFilter = document.getElementById('filter-category')?.value || 'all';

    const filtered = allItems.filter(i => {
      if (typeFilter !== 'all' && i.type !== typeFilter) return false;
      if (categoryFilter !== 'all' && (i.category || '') !== categoryFilter) return false;
      return true;
    });

    const grid = document.getElementById('listings-grid');
    grid.innerHTML = '';
    if (!filtered.length) { grid.innerHTML = '<p class="text-gray-600">No listings found.</p>'; return; }

    filtered.forEach(item => {
      const card = document.createElement('div');
      const borderColor = item.category === 'non-edible' ? 'border-emerald-500' : 'border-orange-500';
      card.className = `bg-white p-4 rounded-2xl shadow-lg border-t-4 ${borderColor}`;
      card.innerHTML = `
        <div class="h-40 w-full rounded-md overflow-hidden mb-3">
          <img src="${item.image || (item.category === 'non-edible' ? 'https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=800&q=60' : 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=60')}" alt="${escapeHtml(item.title)}" class="w-full h-full object-cover">
        </div>
        <h4 class="font-bold text-lg mb-1">${escapeHtml(item.title)}</h4>
        <div class="text-sm text-gray-600 mb-2">${escapeHtml(item.type)} • ${escapeHtml(item.category || '')} • ${escapeHtml(item.quantity ? String(item.quantity) : '')}</div>
        <p class="text-sm text-gray-700 mb-3">${escapeHtml(item.notes || '')}</p>
        <div class="flex gap-2">
          ${item.status === 'available' ? `<button class="py-2 px-3 bg-emerald-600 text-white rounded-md text-sm" onclick="claimListing('${item.id}')">Claim / Request</button>` : `<span class="px-3 py-2 bg-gray-100 rounded-md text-sm">Status: ${escapeHtml(item.status)}</span>`}
          ${item.category === 'non-edible' ? `<button class="py-2 px-3 bg-amber-600 text-white rounded-md text-sm" onclick="sendToAgriculture('${item.id}')">Send to Agriculture</button>` : ''}
        </div>
      `;
      grid.appendChild(card);
    });

    if (window.lucide) lucide.createIcons();
  }

  window.claimListing = async function(listingId) {
    if (!auth?.currentUser) { toast('Please login to claim listings', 'error'); openAuthModal(); return; }
    try {
      await updateDoc(doc(db, 'food_listings', listingId), { status: 'claimed', claimedBy: auth.currentUser.uid, claimedAt: serverTimestamp() });
      toast('You have requested this listing. The owner will be notified.');
    } catch (err) {
      console.error(err);
      toast('Error claiming listing', 'error');
    }
  };

  function renderPublicListingsFilter() {
    // will be triggered when select changes - just refetch (onSnapshot will call render)
    // No-op because fetchPublicListings uses onSnapshot which passes full list into renderPublicListings
    // To be simple, call fetchPublicListings to re-run render
    fetchPublicListings();
  }

  // ================= SIGN OUT =================
  window.signOutUser = async function() {
    if (!auth) { toast('Not connected to Firebase', 'error'); return; }
    try {
      await signOut(auth);
      toast('Signed out successfully');
      window.location.hash = '#home';
    } catch (err) {
      console.error(err);
      toast('Error signing out', 'error');
    }
  };

  // ================= UTILITY =================
  function escapeHtml(str = '') {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  window.alertPlaceholder = function(message) {
    toast(message);
  };

  window.handleFormSubmission = function(e) {
    e.preventDefault();
    toast('Contact form submission handled by frontend app');
    document.getElementById('contact-form').reset();
  };

  // ================= INITIALIZATION =================
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('mobile-menu-button').addEventListener('click', () => {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    checkRoute();
    if (window.lucide) lucide.createIcons();
    fetchPublicListings();
    console.log('Replateo enhanced app initialized.');
  });

  </script>
</body>
</html>
